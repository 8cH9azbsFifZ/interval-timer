<html lang="en">
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta property="og:title" content="Interval Timer" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://greggman.github.io/interval-timer/interval-timer.png" />
    <meta property="og:description" content="An Interval Timer" />
    <meta property="og:url" content="https://greggman.github.io/interval-timer/" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@greggman">
    <meta name="twitter:creator" content="@greggman">
    <meta name="twitter:domain" content="greggman.github.io">
    <meta name="twitter:title" content="Interval Timer">
    <meta name="twitter:url" content="https://greggman.github.io/interval-timer/">
    <meta name="twitter:description" content="An Interval Timer">
    <meta name="twitter:image:src" content="https://greggman.github.io/interval-timer/interval-timer.png">

    <title>Interval Timer</title>
    <link href="icon.png" rel="shortcut icon" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
html {
  box-sizing: border-box;
}
*, *:before, *:after {
  box-sizing: inherit;
}
body {
  margin: 0;
  background-color: #0A0;
  color: white;
  font-family: sans-serif;
  overflow: hidden;
}
h1 {
    margin-top: 0;
}
a {
  text-decoration: none;
  color: inherit;
}
.outer {
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.toolbar {
  background: rgba(0,0,0,.2);
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.round-time {
  gbackground: #0E0;
  width: 100%;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  flex: 1 1 auto;
  align-items: center;
  font-size: 40vh;
}
.round-time .mins,
.round-time .secs {
  flex: 1 1 40%;
}
.round-time .mins {
  gbackground: #0D0;
  text-align: right;
}
.round-time .colon {
  gbackground: #0C0;
  text-align: center;
}
.round-time .secs {
  gbackground: #0B0;
}
.parts {
  display: flex;
  justify-content: space-between;
  padding: 10px;
}
.parts>div {
  flex: 1 1 auto;
}
.parts .part-heading {
  font-size: 5vw;
}
.parts .value {
  font-size: 8vw;
}
.parts .elapsed {
  gbackground: #0A0;
}
.parts .rounds {
  gbackground: #090;
  text-align: center;
}
.parts .remaining {
  gbackground: #080;
  text-align: right;
}
.controls {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  font-size: 6.5vw;
  gborder-top: 1px solid white;
}
.controls .reset,
.controls .start-stop {
  display: flex;
  align-items: center;
}
.controls .curnext {
  display: flex;
  align-items: stretch;
}
.controls>div>div {
  flex: 1 1 auto;
}
.controls .reset,
.controls .start-stop {
  flex: 1 1 10%;
  text-align: center;
  background: rgba(0, 0, 0, .2);
  padding: 5px;
}
.controls .curnext {
  flex: 1 1 80%;
  gbackground: #0FF;
  position: relative;
}
.controls .curnext .allouter {
  position: relative;
  width: 80px;
  gbackground: #F0F;
  overflow: hidden;
}
.controls .curnext .allouter .all {
  position: absolute;
  width: 100%;
  height: 100%;
  gbackground: #FF0;
  white-space: nowrap;
  font-size: 0;
  transition: transform 0.25s cubic-bezier(0.55, 0.06, 0.68, 0.19);
  display: flex;
  align-items: stretch;
}
.controls .curnext .allouter .all>div {
  flex: 0 0 50%;
  font-size: 6.5vw;
  width: 50%;
  display: flex;
  align-items: center;
}
.controls .curnext .allouter .all>div>div {
  padding-left: 10px;
}
.controls .reset {
  gbackground: #070;
}
.controls .curnext .allouter .all>div:nth-child(odd) {
  background: rgba(0, 0, 0, .3);
}
.controls .curnext .allouter .all>div:nth-child(even) {
  background: rgba(0, 0, 0, .4);
}
.controls .start-stop {
  gbackground: #040;
}

.about img {
   width: 1em;
   height: 1em;
}

.dialog {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, .8);
  display: none;
  justify-content: center;
  align-items: center;
}

.dialog .done,
.setting label,
.setting value {
  display: block;
  padding: 2pt;
}

.dialog .done {
  padding: 10pt;
  text-align: center;
  background: rgba(0, 0, 0, .2);
}

.setting value {
  display: block;
  padding: 2pt;
}

.settings .setting {
  margin-bottom: 10pt;
  background: #0A0;
}
.dialog>div {
  background: green;
  padding: 1em;
  font-size: 20pt;
  border: 1em solid black;
  max-width: 90%;
}

.setting input[type="text"] {
  background: rgba(0,0,0,.2);
  border: none;
  font-size: 20pt;
  padding: 2pt;
}

@media (max-aspect-ratio: 12/10) {
  .round-time {
    font-size: 30vw;
  }
}
@media (max-width: 850px) {
  h1 {
     font-size: 24pt;
  }
  p {
     font-size: 16pt;
  }
}
  </style>
  </head>
  <body>
    <div class="outer">
      <div class="toolbar">
        <div>&#9881; Settings</div>
        <div class="aboutButton">About</div>
        <div>Bookmark to save</div>
      </div>
      <div class="round-time">
        <div class="mins">00</div>
        <div class="colon">:</div>
        <div class="secs">00</div>
      </div>
      <div class="parts">
        <div class="elapsed">
          <div class="part-heading">elapsed</div>
          <div class="value">00:00</div>
        </div>
        <div class="rounds">
          <div class="part-heading">interval</div>
          <div class="value">0/0</div>
        </div>
        <div class="remaining">
          <div class="part-heading">remaining</div>
          <div class="value">00:00</div>
        </div>
      </div>
      <div class="controls">
        <div class="reset">
          <div>
            <img src="images/reset.svg" />
          </div>
        </div>
        <div class="curnext">
          <div class="allouter">
            <div class="all">
            </div>
          </div>
        </div>
        <div class="start-stop">
          <div class="start">
             <img src="images/start.svg" />
          </div>
          <div class="stop" style="display: none;">
             <img src="images/stop.svg" />
          </div>
        </div>
      </div>

    </div>
    <div class="settings dialog">
      <div>
        <div class="values"></div>
        <div class="done">done</div>
      </div>
    </div>
    <div class="about dialog">
      <div>
        <div class="desc">
          <h1>An Interval Timer</h1>
          <p>
           Reset: <img src="images/reset.svg" />
           Start: <img src="images/start.svg" />
           Stop: <img src="images/stop.svg" />
          </p>
          <p>On iOS/Android click the share icon
          <img src="images/share.svg" />
          and select "Add to Home Screen" once you've made your setings.
          </p>
          <p>
          On Desktop make a bookmark to save your settings.
          </p>
          <p><a target="_blank" href="https://github.com/greggman/interval-timer/"><img src="images/octocat.svg" /></a>
          </p>
        </div>
        <div class="done">done</div>
      </div>
    </div>
  </body>
  <script src="interval-timer.js"></script>
  <script>
const sounds = {
  beep:     { jsfx: ["sine",0.0000,0.4000,0.0000,0.0980,0.0000,0.0120,20.0000,1740.0000,2400.0000,0.0000,0.0000,0.0000,0.0100,0.0003,0.0000,0.0000,0.0000,0.4435,0.0000,0.0000,0.0000,0.0000,1.0000,0.0000,0.0000,0.1000,0.0000], },
  longBeep: { jsfx: ["sine",0.0000,1.0000,0.0000,0.8460,0.0000,0.0340,20.0000,1740.0000,2400.0000,0.0000,0.0000,0.0000,0.0100,0.0003,0.0000,0.0000,0.0000,0.4435,0.0000,0.0000,0.0000,0.0000,1.0000,0.0000,0.0000,0.1000,0.0000], },
};
const audioManager = new AudioManager(sounds);
const $ = document.querySelector.bind(document);
const elems = getElements({
  body: 'body',
  aboutButton: '.toolbar .aboutButton',
  about: '.about',
  aboutDone: '.about .done',
  toolbar: '.toolbar>div',
  mins: '.round-time .mins',
  secs: '.round-time .secs',
  elapsed: '.parts .elapsed .value',
  rounds: '.parts .rounds .value',
  remaining: '.parts .remaining .value',
  all: '.controls .curnext .allouter .all',
  reset: '.controls .reset',
  start: '.controls .start',
  stop: '.controls .stop',
  settingsForm: '.settings',
  settings: '.settings .values',
  done: '.settings .done',
});
const settingsInfo = [
 { name: 'duration', desc: 'Interval (seconds)', default: 50, },
 { name: 'pause',    desc: 'Break (seconds)',    default: 10, },
 { name: 'rounds',   desc: 'Rounds',             default: 30, },
];
const settings = makeSettings(settingsInfo);
const g = {
  then: 0,
  time: 0,
  requestId: undefined,
  wasInterval: undefined,
  done: false,
};

function makeSettings(settingsInfo) {
  const settings = {};
  settingsInfo.forEach((info, ndx) => {
    settings[info.name] = info.default;
  });
  return settings;
}

function makeSettingsElems() {
  settingsInfo.forEach((info, ndx) => {
    const id = `setting-${ndx}`;
    const selem = document.createElement('div');
    selem.className = 'setting';
    const lelem = document.createElement('label');
    lelem.setAttribute('for', id);
    lelem.textContent = info.desc;
    const ielem = document.createElement('input');
    ielem.title = info.desc;
    ielem.id = id;
    ielem.type = 'text';
    ielem.pattern = '[0-9]*';
    ielem.value = settings[info.name];
    ielem.required = true;
    selem.appendChild(lelem);
    selem.appendChild(ielem);
    elems.settings.appendChild(selem);
    info.readFn = function() {
      let newValue = parseInt(ielem.value);
      if (isNaN(newValue) || !newValue) {
        newValue = info.default;
      }
      ielem.value = newValue;
      settings[info.name] = newValue;
    };
  });
}

function update(now) {
  g.requestId = undefined;
  const elapsedTime = (now - g.then) * 0.001;
  g.then = now;

  g.time += elapsedTime;

  const t = getTimerInfo(g.time);
  if (t.isDone) {
    g.time = t.totalTime;
    stop();
    if (!g.done) {
      g.done = true;
      setTimeout(longBeep, 0);
      setTimeout(longBeep, 1000);
      setTimeout(longBeep, 2000);
    }
  }

  if (t.isInterval !== g.wasInterval) {
    g.wasInterval = t.isInterval;
    audioManager.playSound('longBeep');
  }

  render(g.time);

  run();
}

function longBeep() {
  audioManager.playSound('longBeep');
}

function render(time) {
  const t = getTimerInfo(time);
  const isNewSegment = t.isInterval !== g.oldIsInterval;
  g.oldIsInterval = t.isInterval;

  if (isNewSegment) {
    elems.all.style.transform = `translateX(-${((t.round - 1) * 2 + (t.isInterval ? 0 : 1)) * 50}%)`;
  }

  elems.rounds.textContent = `${t.round}/${settings.rounds}`;

  const clock = secsMinsHours(t.roundTime + 0.99);
  elems.mins.textContent = clock.mins;
  elems.secs.textContent = clock.secs;

  const elapsed = secsMinsHours(time);
  const remain = secsMinsHours(t.remainingTime + 0.99);
  elems.elapsed.textContent = `${elapsed.mins}:${elapsed.secs}`;
  elems.remaining.textContent = `${remain.mins}:${remain.secs}`;

  elems.body.style.background = t.isDone
    ? '#444'
    : (t.isInterval ? '#0A0' : '#F00');
}

function getTimerInfo(time) {
  const roundDuration = settings.duration + settings.pause;
  const totalTime = getTotalTime();
  const remainingTime = Math.max(0, totalTime - time);
  const isDone = remainingTime === 0;
  const roundPauseTime = time % roundDuration;
  const isInterval = isDone ? false : roundPauseTime <= settings.duration;
  const round = (time / roundDuration) + 1 | 0;
  const roundTime = isInterval
    ? settings.duration - roundPauseTime
    : settings.pause - (roundPauseTime - settings.duration);
  return {
    round,           // round number
    roundDuration,   // time of one round + pause
    totalTime,       // time of entire workout
    remainingTime,   // remaing time of entire workout
    isDone,          // true if no time left
    roundPauseTime,  // time in this (round + pause)
    isInterval,      // true if interval
    roundTime,       // time in this rouud OR pause
  };
}

function getTotalTime() {
  return settings.duration * settings.rounds +
         settings.pause * (settings.rounds - 1);
}

function secsMinsHours(time) {
  return {
    hours: (time / 60 / 60 | 0).toFixed(0).padStart(2, '0'),
    mins: (time / 60 % 60 | 0).toFixed(0).padStart(2, '0'),
    secs: (time % 60 | 0).toFixed(0).padStart(2, '0'),
  };
}

function stop() {
  if (g.requestId) {
    cancelAnimationFrame(g.requestId);
    g.requestId = undefined;
  }
  elems.stop.style.display = 'none';
  elems.start.style.display = 'block';
}

function run() {
  if (!g.requestId) {
    g.requestId = requestAnimationFrame(update);
  }
}

function start() {
  elems.stop.style.display = 'block';
  elems.start.style.display = 'none';
  g.then = performance.now();
  run();
}

function reset() {
  g.time = 0;
  g.done = false;
  g.wasInterval = true;
  stop();
  render(g.time);
}

function readSettings() {
  const search = window.location.search;
  if (search) {
    (search.startsWith('?') ? search.substring(1) : search).split('&').forEach((pair) => {
      const keyValue = pair.split('=').map(decodeURIComponent);
      const key = keyValue[0];
      const value = keyValue[1];
      const origValue = settings[key];
      if (origValue !== undefined) {
        if (typeof origValue === 'number') {
          let newValue = parseInt(value);
          if (!isNaN(newValue) && newValue) {
            settings[key] = value;
          }
        } else {
          settings[key] = value;
        }
      }
    });
  }
}

function writeSettings() {
  const search = Object.keys(settings).map((key) => {
    return `${encodeURIComponent(key)}=${encodeURIComponent(settings[key])}`;
  }).join('&');
  window.history.replaceState(settings, '', 
    `${window.location.origin}${window.location.pathname}?${search}`);
}

function setRoundBreak(round, isInterval) {
  audioManager.playSound('beep');
  const t = getTimerInfo(0);
  g.time = (round - 1) * (t.roundDuration) + (isInterval ? 0 : settings.duration);
  start();
}

function makeSetRoundFn(round) {
  return function() {
    setRoundBreak(round, true);
  };
}

function makeSetBreakFn(round) {
  return function() {
    setRoundBreak(round, false);
  };
}

function createRoundElem(text, clickFn) {
  const oelem = document.createElement('div');
  const relem = document.createElement('div');
  relem.innerHTML = text;
  relem.addEventListener('click', clickFn);
  oelem.appendChild(relem);
  elems.all.appendChild(oelem);
}

function noop() {
}

function createRoundsElems() {
  elems.all.innerHTML = '';
  for (let r = 1; r <= settings.rounds; ++r) {
    createRoundElem(`Round ${r}`, makeSetRoundFn(r));
    createRoundElem(r === settings.rounds ? 'End' : `Break ${r}`, makeSetBreakFn(r));
  }
  createRoundElem('&nbsp', noop);
}

readSettings();
writeSettings();
makeSettingsElems();
createRoundsElems();
reset();

elems.aboutButton.addEventListener('click', () => {
  audioManager.playSound('beep');
  stop();
  elems.about.style.display = 'flex';
});
elems.aboutDone.addEventListener('click', () => {
  audioManager.playSound('beep');
  elems.about.style.display = '';
});
elems.reset.addEventListener('click', () => {
  audioManager.playSound('beep');
  reset();
});
elems.start.addEventListener('click', () => {
  audioManager.playSound('beep');
  start();
});
elems.stop.addEventListener('click', () => {
  audioManager.playSound('beep');
  stop();
});
elems.toolbar.addEventListener('click', () => {
  audioManager.playSound('beep');
  stop();
  elems.settingsForm.style.display = 'flex';
});
elems.done.addEventListener('click', () => {
  audioManager.playSound('beep');
  elems.settingsForm.style.display = '';
  settingsInfo.forEach((info) => {
    info.readFn();
  });
  writeSettings();
  reset();
});

function getElements(spec) {
  const elems = {};
  Object.keys(spec).forEach((key) => {
    elems[key] = document.querySelector(spec[key]);
  });
  return elems;
}
  </script>
</html>
